{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the CipherChat application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "username": {
          "type": "string",
          "description": "The username of the user."
        },
        "email": {
          "type": "string",
          "description": "The email address of the user.",
          "format": "email"
        }
      },
      "required": [
        "id",
        "username",
        "email"
      ]
    },
    "ChatMessage": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ChatMessage",
      "type": "object",
      "description": "Represents a chat message within CipherChat.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the chat message."
        },
        "senderId": {
          "type": "string",
          "description": "The username of the User who sent the message."
        },
        "recipientId": {
          "type": "string",
          "description": "The username of the User who is the recipient of the message."
        },
        "senderUid": {
          "type": "string",
          "description": "The UID of the User who sent the message. (Relationship: User 1:N ChatMessage)"
        },
        "recipientUid": {
          "type": "string",
          "description": "The UID of the User who is the recipient of the message. (Relationship: User 1:N ChatMessage)"
        },
        "originalMessage": {
          "type": "string",
          "description": "The original, un-scrambled message text."
        },
        "scrambledMessage": {
          "type": "string",
          "description": "The scrambled version of the message."
        },
        "timestamp": {
          "type": "string",
          "description": "The date and time when the message was sent.",
          "format": "date-time"
        },
        "scrambleMethod": {
          "type": "string",
          "description": "The scrambling method used for this message (e.g., letter substitution, reverse)."
        }
      },
      "required": [
        "id",
        "senderId",
        "recipientId",
        "senderUid",
        "recipientUid",
        "originalMessage",
        "scrambledMessage",
        "timestamp",
        "scrambleMethod"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles. Only the authenticated user can read/write their own profile. Includes standard profile information (username, email).",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user.  Matches request.auth.uid."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/messages/{messageId}",
        "definition": {
          "entityName": "ChatMessage",
          "schema": {
            "$ref": "#/backend/entities/ChatMessage"
          },
          "description": "Stores chat messages for a specific user. This collection acts as an 'inbox' or 'outbox'. Any message where the user is either the sender or receiver is duplicated and stored here. This enables security rules where a user can only read from their own message collection. Requires composite indexes on (`senderUid`, `createdAt`) and (`recipientUid`, `createdAt`).",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user who owns this message collection. Must match request.auth.uid."
            },
            {
              "name": "messageId",
              "description": "The unique identifier for the chat message."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to provide a secure and scalable solution for the CipherChat application, focusing on private user data and messaging. The key principle is Authorization Independence, achieved through path-based ownership and avoiding `get()` calls in security rules. Data is segregated to ensure each collection has a homogeneous security posture, simplifying rules and improving maintainability. \n\nUsers are stored at the `/users/{userId}` path, ensuring only the authenticated user can access their data.  Messages are stored within a subcollection `/users/{userId}/messages/{messageId}`. This structure enables straightforward security rules based on path ownership, ensuring that a user can only read from their own subcollection. To facilitate this, messages are duplicated: one copy is written to the sender's subcollection and another to the recipient's, allowing both parties to have access without compromising security.\n\nThis design supports the QAPs (Rules are not Filters) by ensuring that `list` operations can be securely performed within the `/users/{userId}/messages` collection, as access is determined by path-based ownership."
  }
}
